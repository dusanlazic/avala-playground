from avala import exploit, TargetingStrategy, Batching
import secrets
import string
import json


@exploit(
    service="wish",
    alias="wish",
    batching=Batching(count=5, interval=5),
)
def attack(target: str, flag_ids: str):
    # flag_ids is a JSON string like:
    # {"domain": "anderson-kline.info", "ip": "201.75.251.146"}
    data = json.loads(flag_ids)
    domain = data["domain"]
    ip = data["ip"]

    response = fake_attack(
        f"http://{target}:7000/wishflag",
        params={"domain": domain, "ip": ip},
    )

    return response


@exploit(
    service="wish",
    alias="wish_team_188",
    targets=["10.10.188.1", "10.10.101.1"],
    draft=True,
)
def attack_188_101(target: str, flag_ids: str):
    # teams 188 and 101 patched it but I can't get it to work yet
    # for now its a draft exploit
    pass


@exploit(
    service="history",
    alias="wish_experimental",
    targets=TargetingStrategy.NOP_TEAM,
    draft=True,
)
def dev(target: str, flag_ids: str):
    # attacking nop team only
    pass


### functions used for simulating the attacks ###


def gen_fake_flag() -> str:
    alphabet = string.ascii_letters + string.digits + "+/="
    return "ENO" + "".join(secrets.choice(alphabet) for _ in range(48))


def fake_attack(url: str, *args, **kwargs) -> str:
    return f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gg here's the flag</title>
</head>
<body>
    {gen_fake_flag()}
</body>
</html>
"""
