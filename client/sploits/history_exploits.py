from avala import exploit, Batching
import secrets
import string


@exploit(
    service="history",
    alias="history_1",
    skip=["10.10.236.1"],  # they patched it
    batching=Batching(count=5, interval=5),
    delay=3,
)
def attack(target: str, flag_ids: str):
    user_agent = flag_ids

    response = fake_attack(
        f"http://{target}:5000/gimmeflag",
        headers={"User-Agent": user_agent},
    )

    return response


@exploit(
    service="history",
    alias="history_2",
    targets=["10.10.236.1"],  # patch bypass for team 236
)
def attack_236(target: str, flag_ids: str):
    user_agent = flag_ids

    response = fake_attack(
        f"http://{target}:5000/givemetheflag",
        headers={"User-Agent": user_agent},
    )

    return response


### functions used for simulating the attacks ###


def gen_fake_flag() -> str:
    alphabet = string.ascii_letters + string.digits + "+/="
    return "ENO" + "".join(secrets.choice(alphabet) for _ in range(48))


def fake_attack(url: str, *args, **kwargs) -> str:
    return f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gg here's the flag</title>
</head>
<body>
    {gen_fake_flag()}
</body>
</html>
"""
